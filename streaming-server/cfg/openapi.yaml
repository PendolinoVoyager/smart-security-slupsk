openapi: 3.0.3

info:
  title: Streaming Server API
  version: 1.0.0
  description: >
    API documentation for the Rust-based streaming server.
    Authorization uses a JWT token or a device ID if the server
    runs in 'tokens-are-actually-just-ids' mode.

servers:
  - url: http://localhost:9000
    description: Local development server

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ApiResponse:
      type: object
      required: [status, payload]
      properties:
        status:
          type: string
          example: success
        payload:
          type: string
          enum:
            - success
            - error
    ApiErrorResponse:
      type: object
      required: [payload]
      properties:
        status:
          type: string
          enum:
            - error
        payload:
          type: string
          nullable: false
          example: "Not allowed"
    StreamDevice:
      type: object
      properties:
        id:
          type: integer
          example: 100
        device_name:
          type: string
          example: Default Device
        user_id:
          type: integer
          example: 1
        server_addr:
          type: string
          example: 192.168.8.1:9080

    StreamListPayload:
      type: object
      properties:
        count:
          type: integer
          example: 1
        available:
          type: array
          items:
            $ref: "#/components/schemas/StreamDevice"

    DeviceIdListPayload:
      type: object
      properties:
        count:
          type: integer
          example: 1
        devices:
          type: array
          items:
            type: integer

paths:
  /hello:
    get:
      summary: Get system and device information
      responses:
        "200":
          description: Server information retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - properties:
                      payload:
                        type: object
                        properties:
                          hostname:
                            type: string
                            example: my-server
                          operating_system:
                            type: string
                            example: Linux
                          os_release:
                            type: string
                            example: 5.15.0-84-generic
                          connected_devices:
                            type: integer
                            example: 3
                          config:
                            type: object
                            additionalProperties: true

  /streams:
    get:
      summary: List devices ready for streaming
      responses:
        "200":
          description: Active streams retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - properties:
                      payload:
                        $ref: "#/components/schemas/StreamListPayload"

  /streams/availability:
    get:
      summary: Check if a device is available for streaming
      parameters:
        - in: query
          name: device_id
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Device availability retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - properties:
                      payload:
                        $ref: "#/components/schemas/StreamDevice"

  /streams/all:
    get:
      summary: Get all device IDs currently streaming (service-only)
      description: Only allowed IPs from config can access this endpoint.
      responses:
        "200":
          description: Devices retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - properties:
                      payload:
                        $ref: "#/components/schemas/DeviceIdListPayload"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiErrorResponse"
                  - properties:
                      payload:
                        type: string
                        example: Not a service

  /udp_stream_start:
    get:
      summary: Start a UDP stream
      description: Only allowed IPs from config can access this endpoint.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [device_id, address]
              properties:
                device_id:
                  type: integer
                  example: 100
                address:
                  type: string
                  example: 192.168.1.3:1234
      responses:
        "200":
          description: UDP stream started successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiResponse"
                  - properties:
                      payload:
                        type: object
                        properties:
                          message:
                            type: string
                            example: streaming to 192.168.1.3:1234
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiErrorResponse"
                  - properties:
                      payload:
                        type: string
                        example: Not a service
